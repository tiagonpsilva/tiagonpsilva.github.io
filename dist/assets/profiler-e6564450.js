import{o as J,U as x,V as z,W as H,v as I,X as m,Y as W,Z as v,_ as X,M as Y,L as Z,$,a0 as q,a1 as K}from"./index-6094c9e8.js";function Q(t){let n=0;for(const i of t)i.stackId!==void 0&&n++;return n}const g=new Map;function ee(t,n){g.set(n,t)}function te(t){return g.get(t)}function E(t){for(const n of g.keys())n<t&&g.delete(n)}function ne({rawRumEvent:t,startTime:n}){if(t.type!=="long_task")return;const i=t.long_task.id;ee(i,n)}const se=(t,n,i,s)=>{const f=oe(t,n,i,s),c=ae(t,f),l=n.build("fetch",c);return J("Sending profile to public profiling intake",{profilingIntakeURL:l,applicationId:i,sessionId:s}),fetch(l,{body:c.data,method:"POST"})};function oe(t,n,i,s){const f=n.tags,c=ie(t,i,s),l=re(f);return{...c,attachments:["wall-time.json"],start:new Date(t.startClocks.timeStamp).toISOString(),end:new Date(t.endClocks.timeStamp).toISOString(),family:"chrome",runtime:"chrome",format:"json",version:4,tags_profiler:l.join(","),_dd:{clock_drift:x()}}}function re(t){return t.concat(["language:javascript","runtime:chrome","family:chrome","host:browser"])}function ae(t,n){const i=new Blob([JSON.stringify(t)],{type:"application/json"}),s=new FormData;return s.append("event",new Blob([JSON.stringify(n)],{type:"application/json"}),"event.json"),s.append("wall-time.json",i,"wall-time.json"),{data:s,bytesCount:0}}function ie(t,n,i){const s={application:{id:n}};i&&(s.session={id:i});const f=Array.from(new Set(t.views.map(l=>l.viewId)));f.length&&(s.view={id:f});const c=t.longTasks.map(l=>l.id).filter(l=>l!==void 0);return c.length&&(s.long_task={id:c}),s}const le={sendProfile:se},ce={sampleIntervalMs:10,collectIntervalMs:6e4,minProfileDurationMs:5e3,minNumberOfSamples:50};function de(t,n,i,s=ce){const f=z(H.LONG_ANIMATION_FRAME);let c;const l=[];let r={state:"stopped"};function L(e){r.state!=="running"&&(c=e?{startClocks:e.startClocks,viewId:e.id,viewName:e.name}:void 0,l.push(I(t,window,"visibilitychange",D).stop,I(t,window,"beforeunload",j).stop),p())}async function M(){await h("stopped"),l.forEach(e=>e()),E(m().relative)}function O(e){if(e.state==="running")return{cleanupTasks:e.cleanupTasks,observer:e.observer};const o=[];let a;if(t.trackLongTasks){a=new PerformanceObserver(N),a.observe({entryTypes:[R()]});const d=n.subscribe(12,b=>{ne(b)});o.push(()=>a==null?void 0:a.disconnect()),o.push(d.unsubscribe)}const u=n.subscribe(2,d=>{T({viewId:d.id,viewName:d.name,startClocks:d.startClocks})});return o.push(u.unsubscribe),{cleanupTasks:o,observer:a}}function p(){const e=W().Profiler;if(!e)throw new Error("RUM Profiler is not supported in this browser.");k(r).catch(v);const{cleanupTasks:o,observer:a}=O(r);let u;try{u=new e({sampleInterval:s.sampleIntervalMs,maxBufferSize:Math.round(s.collectIntervalMs*1.5/s.sampleIntervalMs)})}catch(d){X.warn("[DD_RUM] Profiler startup failed. Ensure your server includes the `Document-Policy: js-profiling` response header when serving HTML pages.",d);return}r={state:"running",startClocks:m(),profiler:u,timeoutId:Y(p,s.collectIntervalMs),longTasks:[],views:[],cleanupTasks:o,observer:a},T(c),u.addEventListener("samplebufferfull",w)}async function k(e){var o,a;if(e.state!=="running")return;y((a=(o=e.observer)===null||o===void 0?void 0:o.takeRecords())!==null&&a!==void 0?a:[]),Z(e.timeoutId),e.profiler.removeEventListener("samplebufferfull",w);const{startClocks:u,longTasks:d,views:b}=e,B=m();await e.profiler.stop().then(S=>{const P=m(),F=d.length>0,V=$(u.timeStamp,P.timeStamp)<s.minProfileDurationMs,G=Q(S.samples)<s.minNumberOfSamples;!F&&(V||G)||(_(Object.assign(S,{startClocks:u,endClocks:P,clocksOrigin:q(),longTasks:d,views:b,sampleInterval:s.sampleIntervalMs})),E(B.relative))}).catch(v)}async function h(e){r.state==="running"&&(r.cleanupTasks.forEach(o=>o()),await k(r),r={state:e})}function T(e){r.state!=="running"||!e||r.views.push(e)}function _(e){var o;const a=(o=i.findTrackedSession())===null||o===void 0?void 0:o.id;le.sendProfile(e,t.profilingEndpointBuilder,t.applicationId,a).catch(v)}function w(){p()}function N(e){y(e.getEntries())}function y(e){if(r.state==="running")for(const o of e){if(o.duration<s.sampleIntervalMs)continue;const a=K(o.startTime),u=te(a.relative);r.longTasks.push({id:u,duration:o.duration,entryType:o.entryType,startClocks:a})}}function D(){document.visibilityState==="hidden"&&r.state==="running"?h("paused").catch(v):document.visibilityState==="visible"&&r.state==="paused"&&p()}function j(){p()}function R(){return f?"long-animation-frame":"longtask"}function C(){return r.state==="stopped"}function A(){return r.state==="running"}function U(){return r.state==="paused"}return{start:L,stop:M,isStopped:C,isRunning:A,isPaused:U}}export{ce as DEFAULT_RUM_PROFILER_CONFIGURATION,de as createRumProfiler};
